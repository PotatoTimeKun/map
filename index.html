<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>すしすきーマイクラサーバ マップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh;
    }
  </style>
  <link rel="icon" href="fav.png" type="image/png">
</head>

<body>
  <button id="toggleRailway">線路の表示/非表示</button>

  <script>
    // 表示状態を覚えておく
    var railwayVisible = true;

    document.getElementById('toggleRailway').addEventListener('click', function () {
      if (railwayVisible) {
        map.removeLayer(railwayLayer); // 非表示
      } else {
        map.addLayer(railwayLayer);    // 表示
      }
      railwayVisible = !railwayVisible; // 状態を反転させる
    });

  </script>

  <style>
    body {
      position: relative;
    }

    #toggleRailway {
      position: absolute;
      z-index: 1000;
      top: 10px;
      left: 60px;
    }
  </style>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const VERSION = "?ver=1.4"

    // タイルのサイズを監視して安全に +1px する
    function watchTileSize(tile) {

      let lastWidth = null;
      let lastHeight = null;

      const observer = new MutationObserver(() => {
        const w = parseFloat(tile.style.width);
        const h = parseFloat(tile.style.height);

        // styleが未設定の時は無視
        if (isNaN(w) || isNaN(h)) return;

        // すでに +1px 済みなら何もしない
        if (w === lastWidth && h === lastHeight) return;

        // 現在の Leaflet の設定値を記録（後で比較）
        lastWidth = w;
        lastHeight = h;

        // --- 無限ループ防止のため、一旦監視を止める ---
        observer.disconnect();

        // width / height に +1px
        tile.style.width = (w + 1) + "px";
        tile.style.height = (h + 1) + "px";

        // --- 上書き後に再度監視を開始 ---
        observer.observe(tile, {
          attributes: true,
          attributeFilter: ["style"]
        });
      });

      // 最初の監視開始
      observer.observe(tile, {
        attributes: true,
        attributeFilter: ["style"]
      });
    }


    // タイル追加を検知して監視をセットする
    const tileObserver = new MutationObserver((mutations) => {
      for (const m of mutations) {
        for (const node of m.addedNodes) {
          if (node instanceof HTMLImageElement && node.classList.contains("leaflet-image-layer")) {
            watchTileSize(node);
          }
        }
      }
    });

    tileObserver.observe(document.body, {
      childList: true,
      subtree: true
    });

    // マップを初期化
    var map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -1
    });

    const MAPNUMLIST = [
      [-1, -2], [-1, -1], [-1, 0], [-1, 1], [-1, 2],[-1,3],
      [0, -2], [0, -1], [0, 0], [0, 1], [0, 2],[0, 3],
      [1, -7], [1, -6], [1, -5], [1, -4], [1, -3], [1, -2], [1, -1], [1, 0], [1, 1], [1, 2], [1, 3],
      [2, -6], [2, 0], [2, 1],
      [3, -1], [3, 0]
    ]
    function _putMap(y, x, map) {
      url = `mapData/${y}_${x}.png` + VERSION;
      L.imageOverlay(url, [[500 * y, 500 * x], [500 * (y + 1), 500 * (x + 1)]]).addTo(map);
    }
    function putMapImages(map) {
      MAPNUMLIST.forEach(element => {
        _putMap(element[0], element[1], map)
      });
    }

    // マップタイルの配置
    putMapImages(map);

    // マップの表示範囲
    var bounds = [[-500, -500 * 2], [500 * 3, 500 * 3]]; // 全体をカバーするサイズ
    map.fitBounds(bounds);

    function putMarker(y, x, data, map) {
      var markerHTML = ""
      if (data.title != undefined) markerHTML += `<h2>${data.title}</h2>`
      if (data.explane != undefined) markerHTML += `<p>${data.explane.replaceAll("\n", "<br>")}</p>`
      if (data.image != undefined) markerHTML += `<img style="width: 300px;" src="${data.image}?ver=${VERSION}">`
      L.marker([y, x]).addTo(map)
        .bindPopup(markerHTML);
    }

    // 地点マーカーを置く
    putMarker(
      90, 490,
      {
        title: "マセイモ島",
        explane: "座標: 1220 72 900\n居住者: 塩ポテト君",
        image: "images/maseimo_island.png"
      },
      map
    );
    putMarker(
      300, 780,
      {
        title: "すしすきー大学",
        explane: "座標: 1360 70 750\n制作者: 塩ポテト君",
        image: "images/sushi_uni.png"
      },
      map
    );
    putMarker(
      250, 1140,
      {
        title: "デンチョス城",
        explane: "座標: 1545 65 775<br>制作者: 光奏",
        image: "images/chos_castle.png"
      },
      map
    );
    putMarker(
      -100, 1140,
      {
        title: "建設中？",
        explane: "座標: 1550 231 950\n制作者: 光奏",
        image: "images/denchos_kuchu.jpeg"
      },
      map
    );
    putMarker(
      -300, 790,
      {
        title: "BIG KUCHIBASHI",
        explane: "座標: 1370 62 1114\n制作者: 光奏",
        image: "images/water_kuchibashi.png"
      },
      map
    );
    putMarker(
      730, 650,
      {
        title: "競馬場予定地",
        explane: "建設中\n座標: 1300 70 600\n制作者: チャル建設"
      },
      map
    );
    putMarker(
      865, 765,
      {
        title: "整地師事務所",
        explane: "座標: 1330 70 520\n制作者: 久月",
        image: "images/seichishi.png"
      },
      map
    );
    putMarker(
      865, 330,
      {
        title: "TOJI\'s HOUSE",
        explane: "座標: 1140 64 510\n居住者: たまごとじのすけ",
        image: "images/toji_house.png"
      },
      map
    );
    putMarker(
      80, 20,
      {
        title: "ぺす像",
        explane: "座標: 1000 71 900\n制作者: ?",
        image: "images/pes_zou.png"
      },
      map
    );
    putMarker(
      240, 170,
      {
        title: "Pes Tower",
        explane: "座標: 1045 72 850\n制作者: ?",
        image: "images/pes_tower.png"
      },
      map
    );
    putMarker(
      250, 130,
      {
        title: "四重の塔",
        explane: "座標: 1045 72 850\n制作者: ?",
        image: "images/pes_tower.png"
      },
      map
    );
    putMarker(
      270, -150,
      {
        title: "かじきの家",
        explane: "座標: 882 63 809\n居住者: かじき",
        image: "images/kajiki_house.png"
      },
      map
    );
    putMarker(
      150, -700,
      {
        title: "コロッセオ",
        explane: "座標: 660 71 880\n制作者: てくてく建設",
        image: "images/korosu.png"
      },
      map
    );
    putMarker(
      490, -290,
      {
        title: "トラップタワー&てくてく像",
        explane: "座標: 819 73 703\n制作者: ?",
        image: "images/tt.png"
      },
      map
    );
    putMarker(
      710, 30,
      {
        title: "本拠点 本島",
        explane: "座標: 975 79 590",
        image: "images/base_kyoten.png"
      },
      map
    );
    putMarker(
      750, 50,
      {
        title: "成人男性ハウス",
        explane: "座標: 993 79 580\n制作者: コヤマ",
        image: "images/seijindansei.png"
      },
      map
    );
    putMarker(
      770, -35,
      {
        title: "いじぇハウス",
        explane: "座標: 944 75 571\n居住者: いじぇん",
        image: "images/ije_house.png"
      },
      map
    );
    putMarker(
      730, 200,
      {
        title: "しなりハウス",
        explane: "座標: 1046 87 584\n居住者: しなり",
        image: "images/shinari_house.png"
      },
      map
    );
    putMarker(
      760, 180,
      {
        title: "タマナシ地下迷宮",
        explane: "座標: 1048 87 578\n制作者: タマナシ",
        image: "images/tama_chika.png"
      },
      map
    );
    putMarker(
      760, 260,
      {
        title: "むのむのおうち",
        explane: "座標: 1081 83 581\n居住者: むのむ",
        image: "images/mnm_house.png"
      },
      map
    );
    putMarker(
      700, 310,
      {
        title: "あてむ ず はうす （笑）",
        explane: "座標: 1113 86 598\n居住者: あてむ",
        image: "images/atm_house.png"
      },
      map
    );
    putMarker(
      650, 293,
      {
        title: "デンチョスのお家",
        explane: "座標: 1110 87 611\n居住者: 光奏",
        image: "images/chos_house.png"
      },
      map
    );
    putMarker(
      590, 293,
      {
        title: "デンチョス港",
        explane: "座標: 1108 64 656\n居住者: 光奏"
      },
      map
    );
    putMarker(
      720, 100,
      {
        title: "移転の館",
        explane: "座標: 1010 79 587",
        image: "images/iten.png"
      },
      map
    );
    putMarker(
      790, 110,
      {
        title: "殺し愛の間",
        explane: "座標: 1002 95 550\n制作者: ?",
        image: "images/koroshi.png"
      },
      map
    );
    putMarker(
      620, 110,
      {
        title: "旧デンチョスの家 東屋",
        explane: "座標: 1004 72 636\n制作者: デンチョス",
        image: "images/old_chos.png"
      },
      map
    );
    putMarker(
      820, -540,
      {
        title: "タマナシ城塞",
        explane: "座標: 689 67 552\n制作者: タマナシ",
        image: "images/tama_house.png"
      },
      map
    );
    putMarker(
      775, -510,
      {
        title: "タマナシ港",
        explane: "座標: 689 67 552\n制作者: タマナシ"
      },
      map
    );
    putMarker(
      640, -770,
      {
        title: "しなり城",
        explane: "座標: 611 68 604\n制作者: しなり",
        image: "images/shinari_castle.png"
      },
      map
    );
    putMarker(
      1750, 100,
      {
        title: "北島・コマンドアイランド",
        explane: "座標: 996 82 38",
        image: "images/kita_island.png"
      },
      map
    );
    putMarker(
      170, 240,
      {
        title: "アパート ポテトライフ",
        explane: "座標: 1084 72 847\n制作者: 塩ポテト君\n居住者: 塩ポテト君",
        image: "images/potatolife.png"
      },
      map
    );
    putMarker(
      310, 410,
      {
        title: "イモ クルーズ",
        explane: "座標: 1175 65 788\n制作者: 塩ポテト君",
        image: "images/imoship.png"
      },
      map
    );
    putMarker(
      200, 330,
      {
        title: "レストラン Nyap",
        explane: "座標: 1120 72 848\n制作者: 塩ポテト君",
        image: "images/nyap.png"
      },
      map
    );
    putMarker(
      -70, 420,
      {
        title: "豆腐建築",
        explane: "座標: 1179 65 969\n制作者: 塩ポテト君",
        image: "images/tofu.png"
      },
      map
    );
    putMarker(
      310, 510,
      {
        title: "マセイモ港",
        explane: "座標: 1220 64 801\n制作者: 塩ポテト君"
      },
      map
    );
    putMarker(
      110, 510,
      {
        title: "ハートの桜と空中じゃがいも畑",
        explane: "座標: 1220 72 873\n制作者: 塩ポテト君",
        image: "images/imosakura.png"
      },
      map
    );
    putMarker(
      220, 510,
      {
        title: "マセイモ像",
        explane: "座標: 1233 72 818\n制作者: 塩ポテト君",
        image: "images/imo_statue.png"
      },
      map
    );
    putMarker(
      8, 475,
      {
        title: "罪を償うナス像",
        explane: "制作者: 塩ポテト君"
      },
      map
    );
    putMarker(
      100, 430,
      {
        title: "吊るされるナス像",
        explane: "制作者: 塩ポテト君"
      },
      map
    );
    putMarker(
      140, 445,
      {
        title: "マセイモ交番",
        explane: "制作者: 塩ポテト君"
      },
      map
    );
    putMarker(
      -40, 540,
      {
        title: "マセイモ弓道場",
        explane: "座標: 1236 72 938\n制作者: 塩ポテト君",
        image: "images/imo_kyudo.png"
      },
      map
    );
    putMarker(
      10, 400,
      {
        title: "全自動パンプキンパイ工場",
        explane: "座標: 1161 72 940\n制作者: 塩ポテト君",
        image: "images/kabocha.png"
      },
      map
    );
    putMarker(
      120, 580,
      {
        title: "ジェットコースター乗り場",
        explane: "制作者: 塩ポテト君"
      },
      map
    );
    putMarker(
      250, 565,
      {
        title: "日付カウントアップ回路",
        explane: "制作者: 塩ポテト君",
        image: "images/count.png"
      },
      map
    );
    putMarker(
      260, 550,
      {
        title: "日付カウントアップ回路見学路",
        explane: "制作者: 塩ポテト君",
        image: "images/count2.png"
      },
      map
    );
    putMarker(
      260, 490,
      {
        title: "マセイモ島案内図",
        explane: "制作者: 塩ポテト君"
      },
      map
    );
    putMarker(
      80, 300,
      {
        title: "ポテト港-イモガンダム前",
        explane: "座標: 1108 65 908\n制作者: 塩ポテト君",
        image: "images/imoshipsakura.png"
      },
      map
    );
    putMarker(
      140, 320,
      {
        title: "イモガンダム",
        explane: "座標: 1123 65 892\n制作者: 塩ポテト君",
        image: "images/imogandam.png"
      },
      map
    );
    putMarker(
      230, 270,
      {
        title: "ナス公園（笑）",
        explane: "制作者: 塩ポテト君",
        image: "images/nasupark.png"
      },
      map
    );
    putMarker(
      60, 110,
      {
        title: "とじのすけ像",
        explane: "制作者: 塩ポテト君",
        image: "images/tojinosuke.jpeg"
      },
      map
    );
    putMarker(
      90, 200,
      {
        title: "溶岩にゃぷ",
        explane: "制作者: 塩ポテト君",
        image: "images/lavanyap.jpeg"
      },
      map
    );
    putMarker(
      70, 200,
      {
        title: "のぞき穴",
        explane: "制作者: 塩ポテト君"
      },
      map
    );
    putMarker(
      -400, 200,
      {
        title: "ナスランド",
        explane: "制作者: 塩ポテト君",
        image: "images/nasuland.jpeg"
      },
      map
    );
    putMarker(
      250, 1350,
      {
        title: "武装要塞国家アウターヘブン",
        explane: "座標: 1633 63 766\n制作者: ドグワン",
        image: "images/dogwan_village.jpeg"
      },
      map
    );
    putMarker(
      1050, 810,
      {
        title: "金うんち神社",
        explane: "座標: 1363 70 420\n制作者: しなり？",
        image: "images/gold_unchi.jpeg"
      },
      map
    );
    putMarker(
      1200, 390,
      {
        title: "海上都市 芋ータル(建設中)",
        explane: "座標: 1161 65 346\n制作者: 塩ポテト君",
        image: "images/imo_taru.jpeg"
      },
      map
    );
    putMarker(
      1000, -2800,
      {
        title: "タマナシのやらかし見学ロード",
        explane: "座標: -479 72 427\nやらかし者: タマナシ",
        image: "images/tamanashi_tnt.jpeg"
      },
      map
    );
    putMarker(
      600, -3200,
      {
        title: "月玉農場",
        explane: "座標: -681 63 645\n制作者: 月玉",
        image: "images/tsukitama_house.jpeg"
      },
      map
    );
    putMarker(
      400, 300,
      {
        title: "マセイモ航空 MASE-300YEN",
        explane: "制作者: 塩ポテト君",
        image: "images/imo_airplane.jpeg"
      },
      map
    );
    putMarker(
      520, 1210,
      {
        title: "あかみハウス",
        explane: "座標: 1569 70 701\n制作者: あかみ",
        image: "images/akami_house.jpeg"
      },
      map
    );
    putMarker(
      700, 1180,
      {
        title: "ハムナプトラ2 黄金のピラミッド",
        explane: "制作者: ハンもザ",
        image: "images/piramiddo.jpeg"
      },
      map
    );
    putMarker(
      630, 1400,
      {
        title: "月と玉",
        explane: "制作者: 月玉",
        image: "images/tsukitama.jpeg"
      },
      map
    );
    putMarker(
      630, 1010,
      {
        title: "刃牙の家",
        explane: "制作者: ハンもザ？(不明)",
        image: "images/baki.jpeg"
      },
      map
    );
    putMarker(
      470, 1450,
      {
        title: "あかみサンダーマウンテン",
        explane: "座標: 1681 72 716\n制作者: あかみ",
        image: "images/akamijet.png"
      },
      map
    );
    putMarker(
      710, 1320,
      {
        title: "めい城(仮名称)",
        explane: "制作者: めい",
        image: "images/mei_castle.jpeg"
      },
      map
    );
    putMarker(
      800, 1450,
      {
        title: "金玉",
        explane: "制作者不明",
        image: "images/kintama.jpeg"
      },
      map
    );
    putMarker(
      400, 1230,
      {
        title: "えびちゃんやっほ～",
        explane: "制作者: ドグワン",
        image: "images/ebi.jpeg"
      },
      map
    );
    putMarker(
      -310, 1900,
      {
        title: "おしろ",
        explane: "制作者 : 月玉",
        image: "images/shiro.jpeg"
      },
      map
    );

    // 線路用のレイヤーグループを作る
    var railwayLayer = L.layerGroup([]);

    function drawRailway(points, name, color) {
      var polyline = L.polyline(points, { color: color, className: "railway-line" }).addTo(railwayLayer);
      polyline.bindTooltip(name, {
        permanent: true,     // 常に表示する
        direction: 'center', // 線の中心に表示
        className: 'railway-label' // CSSでデザインもできるよ
      }).openTooltip();
    }

    // 線路を引く
    drawRailway(
      [
        [170, 473],
        [190, 473],
        [190, 640],
        [530, 640]
      ],
      'ポテト線',
      '#ff8888'
    );

    drawRailway(
      [
        [170, 473],
        [200, 473],
        [200, 175],
        [50, 175],
        [50, 148],
        [-300, 148],
        [-300, 190]
      ],
      'ポテト線',
      '#ff8888'
    );

    drawRailway(
      [
        [105, 100],
        [105, -550],
        [80, -550]
      ],
      'コロッセオ線',
      '#ff0000'
    );

    drawRailway(
      [
        [105, 100],
        [105, 150],
        [650, 150],
        [650, 50],
        [675, 50]
      ],
      'メトロぺす線',
      '#ffffff'
    );

    drawRailway(
      [
        [675, 50],
        [675, 30],
        [1255, 30],
        [1255, 175],
        [1800, 175]
      ],
      '北線',
      '#8844ff'
    );

    drawRailway(
      [
        [675, 50],
        [675, 450],
        [530, 450],
        [530, 1141],
        [370, 1141]
      ],
      'デンチョス線',
      '#ffff00'
    );

    drawRailway(
      [
        [750, 0],
        [750, -2540],
        [1050, -2540],
        [1050, -2780]
      ],
      'すしスキー線',
      '#00ffff'
    );

    drawRailway(
      [
        [530, 845],
        [942, 845],
        [942, 750]
      ],
      '整地師線',
      '#0000ff'
    );

    drawRailway(
      [
        [450, 1150],
        [450, 1210],
        [375, 1210],
        [375, 1265],
        [290, 1265],
        [290, 1290]
      ],
      'ドグワン線',
      '#ffaa00'
    );

    function drawStation(point, name, cssClass, railwayLayer) {
      var myIcon = L.divIcon({ className: cssClass, iconAnchor: [13, 13] });
      L.marker(point, { icon: myIcon }).addTo(railwayLayer)
      L.tooltip({
        permanent: true,
        direction: 'right', // 右側に表示
        className: 'station-label',
        offset: [10, 0]
      })
        .setContent(name)
        .setLatLng(point)
        .addTo(railwayLayer);
    }

    drawStation([170, 473], 'マセイモ駅', 'icon1', railwayLayer);
    drawStation([105, 175], 'ポテトぺす駅', 'icon1', railwayLayer);
    drawStation([-300, 190], 'ナスランド駅', 'icon1', railwayLayer);

    drawStation([80, -550], 'コロッセオ駅', 'icon2', railwayLayer);

    drawStation([105, 100], 'ぺす像前駅', 'icon3', railwayLayer);
    drawStation([260, 150], 'ぺす公園駅', 'icon3', railwayLayer);

    drawStation([675, 50], '中央駅', 'icon4', railwayLayer);
    drawStation([1050, -2780], '初期スポーン駅', 'icon4', railwayLayer);

    drawStation([675, 290], 'デンチョス駅', 'icon5', railwayLayer);
    drawStation([530, 640], '切り替え', 'icon5', railwayLayer);
    drawStation([530, 845], '切り替え', 'icon5', railwayLayer);
    drawStation([370, 1141], 'デンチョス城駅', 'icon5', railwayLayer);

    drawStation([942, 750], '拠点前駅', 'icon6', railwayLayer);

    drawStation([290, 1290], 'アウターヘブン駅', 'icon7', railwayLayer);

    railwayLayer.addTo(map)
  </script>
  <style>
    .railway-line {
      stroke-dasharray: 0.1 7;
      stroke-width: 5;
    }

    .icon1 {
      width: 20px !important;
      height: 20px !important;
      border-radius: 10px;
      border: 3px solid #fdfdfd;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
      background-color: rgb(255, 150, 157);
    }

    .icon2 {
      width: 20px !important;
      height: 20px !important;
      border-radius: 10px;
      border: 3px solid #fdfdfd;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
      background-color: rgb(255, 0, 0);
    }

    .icon3 {
      width: 20px !important;
      height: 20px !important;
      border-radius: 10px;
      border: 3px solid #fdfdfd;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
      background-color: rgb(255, 255, 255);
    }

    .icon4 {
      width: 20px !important;
      height: 20px !important;
      border-radius: 10px;
      border: 3px solid #fdfdfd;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
      background-color: rgb(0, 255, 255);
    }

    .icon5 {
      width: 20px !important;
      height: 20px !important;
      border-radius: 10px;
      border: 3px solid #fdfdfd;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
      background-color: rgb(255, 255, 0);
    }

    .icon6 {
      width: 20px !important;
      height: 20px !important;
      border-radius: 10px;
      border: 3px solid #fdfdfd;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
      background-color: rgb(0, 0, 255);
    }

    .icon7 {
      width: 20px !important;
      height: 20px !important;
      border-radius: 10px;
      border: 3px solid #fdfdfd;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
      background-color: rgb(255, 174, 0);
    }

    .leaflet-image-layer {
      image-rendering: pixelated;
      /* 一番効果が高い */
      image-rendering: crisp-edges;
    }
  </style>

</body>

</html>